<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">

<title>Gridbee Grid Client</title>

<script type="text/javascript" src="lib/jquery.js"></script>
<script type="text/javascript" src="lib/jquery.tmpl.js"></script>
<script type="text/javascript" src="lib/knockout.js"></script>
<script type="text/javascript" src="lib/framework.js"></script>
<script type="text/javascript" src="gridbee.js"></script>

<link rel="stylesheet" type="text/css" href="gridbee.css" />

</head>
<body>

<div class="worksource" id="header">
  <div class="leftpanel">
  <div id="app-name"> GRIDBEE </div>
  <div id="app-description"> the grid computing web app </div>

  <div id="runcontrol" onselectstart="return false;"
       data-bind="click : function() {running(!running());},
                  css : {running : running(), stopped : !running()}">
    <span class="stop">&#x25FC</span>
    <span class="play">&#x25B6</span>
  </div>

  <div id="threadnumber" onselectstart="return false;">
    <span class="minus"
          data-bind="click : function() {threads(Math.max(1,threads()-1))}">
      -
    </span>
    <span class="number" data-bind="text : threads"></span>
    <span class="plus"
          data-bind="click : function() {threads(threads() + 1)}">
      +
    </span>
  </div>
  
  <div id="state-describtion">
    <span data-bind="css : {hidden : running()}, text : running() ? '' : 'Computation'"></span>
    <b data-bind="text : running() ? 'Running' : 'stopped'"></b>
    <span data-bind="css : {hidden : !running()}"> on <b data-bind="text: threads">3</b> threads </span>
  </div>

  </div>

  <div class="rightpanel">
    <h1 id="overview-button"
        class="selectable selected"
        onclick="selectItem(this)">
      Overview
    </h1>
    <h1 id="newworksource-button"
        class="selectable selector"
        onclick="selectItem(this)">
      Add new worksource
    </h1>
  </div>
</div>

<div id="template-selector">
  <ul data-bind="template : {name : 'informationform', foreach : templates}">
    <script type="text/html" id="informationform">
    <li data-bind="attr : {templatename : templatename}"
        onclick="selectTemplate(this.getAttribute('templatename'))">
      <h2 class="selectable selector"
          data-bind="text : formtitle">
      </h2>
      
      <p data-bind="text : description">
      </p>
    </li>
    </script>
  </ul>
</div>

<script>
  function selectItem(h1) {
    // Do not allow selection of an item in the template list
    if ($('#worksourcelist .template').find(h1).length > 0) return;

    $('#worksourcelist .worksource:not(.template), #template-selector, #header h1, #header').removeClass('selected');

    // If the selected item is not the newworksource, then unselect all templates
    if ($(h1).attr('id') != 'newworksource-button') {
      selectTemplate(null);
    }

    if ($('#header').find(h1).length === 0) {
      $(h1).parent().parent().addClass('selected');
    } else {
      $(h1).addClass('selected');
      if ($(h1).attr('id') == 'newworksource-button') {
        $(h1).parent().parent().addClass('selected');
        $('#template-selector').addClass('selected');
      }
    }
  }
  $(function(){
    if(window.gears.worksources().length == window.gears.templates.length)
      selectItem($('#newworksource-button'));
   });

  function setTemplatesHeight() {
    var margintop;
    var margin = $('#header').outerHeight() / 7.3 * 2.5;
    if ($('#worksourcelist .template.selected').length === 0) {
      margintop = margin;
    } else {
      var height = $('#worksourcelist .template.selected .rightpanel').outerHeight();
      margintop = height + margin*2
    }
    $('#worksourcelist li:not(.template):first').css('margin-top', margintop);
  }

  function selectTemplate(templatename) {
    if (templatename == null) {
      $('#template-selector li').removeClass('selected');
      $('#worksourcelist li.template').removeClass('selected');
    } else {
      selector = $('#template-selector li[templatename="' + templatename + '"]');
      template = $('#worksourcelist li.template[templatename="' + templatename + '"]');

      selector.addClass('selected')
              .siblings().removeClass('selected');

      template.addClass('selected')
              .siblings().removeClass('selected');
    }

    setTemplatesHeight();
  }

  function checkTemplateCreation(e) {
    if (e.target.tagName.toLowerCase() !== 'button') return;

    var button = $(e.target);
    var worksource = button.parent().parent().parent().parent();
    var templatename = worksource.attr('templatename');
    if (templatename === undefined) return;

    selectTemplate(null);
    worksource.addClass('selected');
    setTimeout(function() { selectItem(worksource.find('h1.selector')[0]); }, 0);
  }
  document.addEventListener('click', checkTemplateCreation, true);

  function checkNonEmptyInputs(e) {
    if (e.target.tagName.toLowerCase() !== 'input') return;

    var input = $(e.target);
    if (e.charCode !== 0) {
      input.addClass('nonempty');
    } else {
      if (input.val().length > 0) {
        input.addClass('nonempty');
      } else {
        input.removeClass('nonempty');
      }
    }
  }
  document.addEventListener('keypress', checkNonEmptyInputs, false);
  document.addEventListener('keyup', checkNonEmptyInputs, false);
</script>

<ul id="worksourcelist"
     data-bind="template: {name : 'worksource', foreach : worksources}">

  <script type="text/html" id="worksource">
    <li class="worksource"
        data-bind="attr : {templatename : template() ? templatename : ''},
                   css : {template : template()}">

      <ul class="leftpanel"
          data-bind="template : {name : 'workunit', foreach : workunits}">
      </ul>

      <div class="rightpanel">
        <h1 class="selectable selector"
            data-bind="text : name"
            onclick="selectItem(this)">
        </h1>
        <form class="overview"
              data-bind="template : {name : 'informationform-' + type, data : $data}">
        </form>
      </div>

    </li>
  </script>

  <script type="text/html" id="workunit">
    <li class="workunit">
      <span class="status"
            data-bind="text : status">
      </span>

      <div class="meter">
        <span data-bind="style : {width : progress()*100 + '%'}">
      </div>
    </li>
  </script>

</ul>

</body>
</html>
