<!DOCTYPE html>
<html>
<head>
	
<meta charset="utf-8">

<title>Web Computing</title>

<script type="text/javascript" src="lib/jquery.js"></script>
<script type="text/javascript" src="lib/jquery.tmpl.js"></script>
<script type="text/javascript" src="lib/knockout.js"></script>
<script language="JavaScript" src="js/SimpleClient.js"></script>

<link rel="stylesheet" type="text/css" href="css/style.css" />

</head>
<body onload="Main.onload()">

<pre id="haxe:trace" style="display:none"></pre>

<div id="top">
	<img data-bind="css : {rotating : running}" src="img/gear1-bw.svg" style="float: left; height: 2.3em; margin: 0.35em;" />
	<span id="appname">GEARS</span>
	<span id="appdescription">the WebComputing grid client</span>
	<div id="runcontrol" data-bind="click : function() {running(!running())}, css : {running : running(), stopped : !running()}" onselectstart="return false;">
   		<span class="stop">&#x25FC</span>
   		<span class="play">&#x25B6</span>
    </div>
   	<div id="threadnumber" onselectstart="return false;">
		<span class="minus" data-bind="click : function() {if (threads() > 1) threads(threads() - 1)}">
       		-
    	</span><span class="number" data-bind="text : threads">
    	</span><span class="plus" data-bind="click : function() {threads(threads() + 1)}">
       		+
        </span>
	</div>
	<span id="threadnumber-description">simultaneously running workunit allowed</span>
	<img id="terminalpanel-button" onclick="select('.panel', '#log', true, '#mainpanel')" src="img/terminal.png" />
</div>

<div class="panel console" id="log">
	Valami
</div>
<div class="panel active" id="mainpanel">
<div id="newworksource" class="worksource">
	<h3>Add new worksource</h3>
	<script type="text/javascript">
		function selectworksource(name) {
			if ($('ul.worksourcetypes li').not('.' + name).hasClass('active'))
			{
				$('ul.worksourcetypes li').not('.' + name).removeClass('active');
			}
			else
			{
				$('ul.worksourcetypes li').addClass('active');			
			}
			select('.createform','.' + name, true);
		}
	</script>

<!--	<ul class="worksourcetypes" data-bind="template: {name : 'worksourcetype'}" >
		<script type="text/html" id="worksourcetype">
			{{each(name, worksourcetype) viewModel.worksourcetypes}} 
				<li class="active ${ name }" class="worksourcetype" onclick="selectworksource('${ name }')">
					<img title="${ worksourcetype.description }" src="${ worksourcetype.icon }" />
				</li>
			{{/each}}
		</script>-->
	<ul class="worksourcetypes">
		<li class="active boincdev" class="worksourcetype">
			<img src="http://boinc.berkeley.edu/logo/www_logo.gif" />
		</li>
	</ul>
	
	<div class="createform boinc">
		<div class="fieldset">
			<label>Project url:</label>
			<input value="Project url"
			       onkeydown="viewModel.worksourcetypes.boinc.projecturl_ok(false);viewModel.worksourcetypes.boinc.ok(false)"
			       data-bind="value : worksourcetypes.boinc.parameters.url" />
			<button onclick="viewModel.worksourcetypes.boinc.checkprojecturl()">Check</button>
		</div>
		<div class="or">
			<div class="fieldset">
				<label>Username: </label>
				<input data-bind="enable : worksourcetypes.boinc.projecturl_ok,
				                  value : worksourcetypes.boinc.parameters.username"
				       onkeydown="viewModel.worksourcetypes.boinc.ok(false)" />
				<label>Password:</label>
				<input data-bind="enable : worksourcetypes.boinc.projecturl_ok,
				                  value : worksourcetypes.boinc.parameters.password"
				       onkeydown="viewModel.worksourcetypes.boinc.ok(false)" />
				<button data-bind="enable : worksourcetypes.boinc.projecturl_ok"
				        onclick="viewModel.worksourcetypes.boinc.checklogin()">Check</button>
			</div>
			<div class="fieldset">
				<label>Authkey: </label>
				<input data-bind="enable : worksourcetypes.boinc.projecturl_ok,
				                  value : worksourcetypes.boinc.parameters.authkey"
				       onkeydown="viewModel.worksourcetypes.boinc.ok(false)" />
				<button data-bind="enable : worksourcetypes.boinc.projecturl_ok"
				        onclick="viewModel.worksourcetypes.boinc.checkauthkey()">Check</button>
			</div>
		</div>
		<div class="submit">
			<button data-bind="enable : worksourcetypes.boinc.ok">Create</button>
			<p>Lorem ipsum error</p>
		</div>
	</div>

	<div class="createform boincdev active">
		<div class="fieldset">
			<label>Scheduler url:</label>
			<input data-bind="value : worksourcetypes.boincdev.parameters.scheduler" />
		</div>
		<div class="fieldset">
			<label>Auth key:</label>
			<input data-bind="value : worksourcetypes.boincdev.parameters.authkey" />
		</div>
		<div class="submit">
			<button data-bind="enable : worksourcetypes.boincdev.ok, click : worksourcetypes.boincdev.create">Create</button>
			<p>Lorem ipsum error</p>
		</div>
	</div>

</div>

<div id="worksource_list" style="display: none"></div>

<div id="worksourcelist" data-bind='template: {name : "projectFrame",
	                                        foreach : projects}'>
	<script type="text/html" id="projectFrame">
	<div class="worksource">
		<h3 data-bind="text: name"></h3>
		<img class="settingsbutton" onclick="$(this).toggleClass('enabled')" src="img/gear2.svg" />
		<div class="settings">
			<p>Project name: <span data-bind="text : name"></span></p>
			<p>Project url: <a data-bind="text : url, attr : {href : url}"></a></p>
			<p>Authentication key: <span data-bind="text : authkey"></span></p>
		</div>
		<ul class="workunits" data-bind='template : {name : "workunit",
		                                             foreach : workunits}'>
	    </ul>
	</div>
	</script>
	<script type="text/html" id="workunit">
	<li class="workunit">
		<img class="terminal-icon" data-bind="click : function(){consoleenabled(!consoleenabled());}" src="img/terminal.png"/>
		
		<span class="state" data-bind="text : state"></span>
		
		<div class="meter">
			<span data-bind="style : {width : progress() + '%'}"></span>
		</div>
		
		<textarea class="terminal" data-bind="value : console,
		                                      style : {display : consoleenabled() ? 'block' : 'none'}">
		</textarea>
	</li>
	</script>
</div>
</div>
<script type="text/javascript">
var select = function(set, select, unselect, defaultSelect)
{
	//console.log(select);
	set = $(set);
	var target = set.filter(select);
	if (unselect === true && target.hasClass('active'))
	{
		target.removeClass('active');
		if (typeof(defaultSelect) != 'undefined')
		{
			set.filter(defaultSelect).addClass('active');
		}
		return;
	}
	set.filter('.active').removeClass('active');
	target.addClass('active');
}

var togglePanel = function(panelId)
{
	var selected = $('.panel').filter('.active')[0];
	$('.panel').filter('.active').removeClass('active');
	if (selected.getAttribute('id') === panelId)
	{
		$('#mainpanel').addClass('active');
	} else {
		$('#' + panelId).addClass('active');
	}
}

var viewModel = {
	running : ko.observable(true),
	
	threads : ko.observable(1),
	
	projects : ko.observableArray([]),
	
	newworksource : {
		type : ko.observable(''),
		url : ko.observable(''),
		authkey : ko.observable(''),
		username : ko.observable(''),
		password : ko.observable('')
	},
	
	worksourcetypes : {
		boinc : {
			icon : 'http://boinc.berkeley.edu/logo/www_logo.gif',
			description : 'BOINC project',
			parameters : {
				url : ko.observable(''),
				authkey : ko.observable(''),
				username : ko.observable(''),
				password : ko.observable('')
			},
			projecturl_ok : ko.observable(false),
			ok : ko.observable(false),
			create : function() {
				alert('boinc worksource create');
			},
			checkprojecturl : function() {
				viewModel.worksourcetypes.boinc.projecturl_ok(true);
				console.log(1);
			},
			checklogin : function() {
				viewModel.worksourcetypes.boinc.ok(true);
			},
			checkauthkey : function() {
				viewModel.worksourcetypes.boinc.ok(true);
			},
		},
		boincdev : {
			icon : 'http://boinc.berkeley.edu/logo/www_logo.gif',
			description : 'BOINC dev project',
			parameters : {
				scheduler : ko.observable('http://ui.hpc.iit.bme.hu/wcdemo_cgi/cgi'),
				authkey : ko.observable('1d0f37563ceb7d1ed372a932dcdb5d85'),
			},
			ok : ko.observable(true),
			create : function() {
				var scheduler = viewModel.worksourcetypes.boincdev.parameters.scheduler();
				var authkey = viewModel.worksourcetypes.boincdev.parameters.authkey();
				var ws = new web2grid.worksource.boinc.BoincWorkSource(scheduler, authkey);
				Main.client.addWorkSource(ws);
				console.log('New worksource added: ', ws);
			},
		},
		debug : {
			icon : 'img/gear2.svg',
			description : 'Debug worksource',
		}
	},
	
};

viewModel.worksourcetypes.boinc.checkfunction = ko.dependentObservable(function(){
	return this.url().length > 0 && (this.authkey().length > 0 || (this.username().length > 0 && this.password().length > 0));
}, viewModel.worksourcetypes.boinc.parameters);


ko.applyBindings(viewModel);

</script>


<script type="text/javascript">
// BOINCdev bindings:
viewModel.running.subscribe(function(newValue){
	Main.toggle();
});

viewModel.threads.subscribe(function(newValue){
	Main.client.setTargetActiveWorkNumber(newValue);
	console.log('Number of threads: ', newValue);
});

function findWorkunit(wu) {
	for (var i = 0; i < viewModel.projects().length; i++) {
		var project = viewModel.projects()[i];
		if (project.worksource === ws) return project;
	}
	return null;
}

function findWorksource(ws) {
	for (var i = 0; i < viewModel.projects().length; i++) {
		var project = viewModel.projects()[i];
		if (project.worksource === ws) return project;
	}
	return null;
}


function updateWorkunit(workunit) {
	//console.log('Updating workunit: ', workunit, workunit.workunit.name, workunit.workunit.getState(), workunit.workunit.progress);
	if (Main.client.activeworks.indexOf(workunit.workunit) === -1) {
		workunit.state('Passive');
	} else {
		workunit.state(workunit.workunit.getState());
	}
	workunit.progress(workunit.workunit.progress ? workunit.workunit.progress * 100 : 0);
}


function updateWorkunits(project) {
	//console.log('Updating project: ', project);
	var workunits = Main.client.activeworks.concat(Main.client.passiveworks);
	// Removing workunits that no longer exist
	for (var i = 0; i < project.workunits().length; i++) {
		var workunit = project.workunits()[i].workunit;
		if (workunits.indexOf(workunit) === -1) {
			//console.log('Removing workunit: ', workunit);
			project.workunits.remove(project.workunits()[i]);
		}
	}
	
	// Adding workunits not listed yet
	projectworkunits = project.workunits().map(function(wu){return wu.workunit});
	for (var i = 0; i < workunits.length; i++) {
		var workunit = workunits[i];
		if (workunit.source !== project.worksource) continue;
		if (projectworkunits.indexOf(workunit) === -1) {
			//console.log('New workunit found: ', workunit, workunit.name);
			project.workunits.push({
				workunit : workunit,
	 			state : ko.observable('Computing...'),
	 			progress : ko.observable(50),
	 			console : ko.observable('console2'),
	 			consoleenabled : ko.observable(false)				
			});
		}
	}

	for (var i = 0; i < project.workunits().length; i++) {
		updateWorkunit(project.workunits()[i]);
	}
}

function updateWorksources() {
	//console.log('Updating Worksources: ', viewModel.projects());
	var worksources = Main.client.getWorkSources();
	// Removing projects that no longer exist
	for (var i = 0; i < viewModel.projects().length; i++) {
		var project = viewModel.projects()[i];
		if (worksources.arr.indexOf(project.worksource) === -1) {
			//console.log('Removing worksource: ', project.worksource);
			viewModel.projects.remove(project);
		}
	}
	
	// Adding projects not listed yet
	for (var i = 0; i < worksources.arr.length; i++) {
		var worksource = worksources.arr[i];
		var project = findWorksource(worksource);
		if (project == null) {
			//console.log('New worksource found: ', worksource);
			viewModel.projects.push({
				worksource : worksource,
				name : worksource.getScreenName(),
				url : worksource.scheduler_url,
				authkey : worksource.authinfo.authenticator,
				workunits : ko.observableArray([])
			});
		}
	}
	
	// Refreshing existing worksources
	for (var i = 0; i < viewModel.projects().length; i++) {
		updateWorkunits(viewModel.projects()[i]);
	}
}

setInterval(updateWorksources, 1000);

</script>

</body>
</html>